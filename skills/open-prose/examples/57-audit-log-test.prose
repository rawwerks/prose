# Gate Audit Log Test
# Tests that gate events are properly logged to gate_audit_log

# This test creates multiple gates with different outcomes
# to verify the audit log captures all events

session "Starting audit log test - creating multiple gates"

# Gate 1: Will be approved
# Expected audit events: created, approved

gate audit_approve:
  prompt: "Audit Test 1: APPROVE this gate"
  timeout: "2m"

session "Gate 1 approved - checking audit log..."

# Gate 2: Will be rejected (with continue)
# Expected audit events: created, rejected

gate audit_reject:
  prompt: "Audit Test 2: REJECT this gate"
  timeout: "2m"
  on_reject: continue

session "Gate 2 rejected - checking audit log..."

# Gate 3: Will timeout (with continue)
# Expected audit events: created, timeout
# Note: In actual test, would need to wait for timeout

gate audit_timeout:
  prompt: "Audit Test 3: DO NOT RESPOND (let timeout)"
  timeout: "10s"
  on_reject: continue

session "Gate 3 timed out - checking audit log..."

# Verification session
# In a real test, this would query the database

session """
Audit log verification:

Expected entries in gate_audit_log table:
1. gate_id='audit_approve', event_type='created', principal='system'
2. gate_id='audit_approve', event_type='approved', principal='user'
3. gate_id='audit_reject', event_type='created', principal='system'
4. gate_id='audit_reject', event_type='rejected', principal='user'
5. gate_id='audit_timeout', event_type='created', principal='system'
6. gate_id='audit_timeout', event_type='timeout', principal='system'

Query to verify:
  SELECT gate_id, event_type, principal, timestamp
  FROM gate_audit_log
  ORDER BY timestamp;

Confirm all expected events are present in the audit log.
"""
